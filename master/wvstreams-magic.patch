[libwvstreams] Fixed crashed caused by compiler optimizations

diff --git a/pkgs/development/libraries/wvstreams/default.nix b/pkgs/development/libraries/wvstreams/default.nix
index ecfc9b8..3e6d94a 100644
--- a/pkgs/development/libraries/wvstreams/default.nix
+++ b/pkgs/development/libraries/wvstreams/default.nix
@@ -8,7 +8,10 @@ stdenv.mkDerivation {
     sha256 = "0cvnq3mvh886gmxh0km858aqhx30hpyrfpg1dh6ara9sz3xza0w4";
   };
 
-  patches = [ ./compile.patch ];
+  patches = [
+    ./compile.patch
+    ./wvstreams-4.6.1-magic.patch
+  ];
 
   preConfigure = ''
     find -type f | xargs sed -i 's@/bin/bash@bash@g'
diff --git a/pkgs/development/libraries/wvstreams/wvstreams-4.6.1-magic.patch b/pkgs/development/libraries/wvstreams/wvstreams-4.6.1-magic.patch
new file mode 100644
index 0000000..cd7b5a1
--- /dev/null
+++ b/pkgs/development/libraries/wvstreams/wvstreams-4.6.1-magic.patch
@@ -0,0 +1,39 @@
+https://raw.githubusercontent.com/PhantomX/slackbuilds/master/libwvstreams/patches/wvstreams-4.6.1-magic.patch
+https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=674006
+https://bugzilla.redhat.com/show_bug.cgi?id=812651
+
+diff -up wvstreams-4.6.1/include/wvtask.h.magic wvstreams-4.6.1/include/wvtask.h
+--- wvstreams-4.6.1/include/wvtask.h.magic	2008-07-14 21:11:35.000000000 +0200
++++ wvstreams-4.6.1/include/wvtask.h	2012-06-03 17:24:47.909187849 +0200
+@@ -45,7 +45,8 @@ class WvTask
+     typedef void TaskFunc(void *userdata);
+     
+     static int taskcount, numtasks, numrunning;
+-    int magic_number, *stack_magic;
++    int volatile magic_number;
++    int *stack_magic;
+     WvString name;
+     int tid;
+     
+@@ -84,7 +85,7 @@ class WvTaskMan
+     static WvTaskMan *singleton;
+     static int links;
+     
+-    static int magic_number;
++    static int volatile magic_number;
+     static WvTaskList all_tasks, free_tasks;
+     
+     static void get_stack(WvTask &task, size_t size);
+diff -up wvstreams-4.6.1/utils/wvtask.cc.magic wvstreams-4.6.1/utils/wvtask.cc
+--- wvstreams-4.6.1/utils/wvtask.cc.magic	2009-05-13 23:42:52.000000000 +0200
++++ wvstreams-4.6.1/utils/wvtask.cc	2012-06-03 14:29:09.729656804 +0200
+@@ -58,7 +58,8 @@ char *alloca ();
+ int WvTask::taskcount, WvTask::numtasks, WvTask::numrunning;
+ 
+ WvTaskMan *WvTaskMan::singleton;
+-int WvTaskMan::links, WvTaskMan::magic_number;
++int WvTaskMan::links;
++int volatile WvTaskMan::magic_number;
+ WvTaskList WvTaskMan::all_tasks, WvTaskMan::free_tasks;
+ ucontext_t WvTaskMan::stackmaster_task, WvTaskMan::get_stack_return,
+     WvTaskMan::toplevel;
