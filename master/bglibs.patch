From: Tomas Zeman <tzeman@volny.cz>
Subject: [PATCH] tg/bglibs

bglibs-1.106: One stop library package

diff --git a/pkgs/development/libraries/bglibs/bg-installer.patch b/pkgs/development/libraries/bglibs/bg-installer.patch
new file mode 100644
index 0000000..93718e4
--- /dev/null
+++ b/pkgs/development/libraries/bglibs/bg-installer.patch
@@ -0,0 +1,11 @@
+--- bglibs-1.106.orig/Makefile	2009-02-19 17:11:51.000000000 +0000
++++ bglibs-1.106/Makefile	2013-09-10 20:02:54.160098939 +0000
+@@ -90,7 +90,7 @@
+ 	./ltcompile base64/encode_part.c
+ 
+ bg-installer: bg-installer.o ltload libbg-cli.la libbg-msg.la libbg-path.la libbg-iobuf.la libbg-fmt.la libbg-str.la libbg-sysdeps.la
+-	./ltload bg-installer libbg-cli.la libbg-msg.la libbg-path.la libbg-iobuf.la libbg-fmt.la libbg-str.la libbg-sysdeps.la -static 
++	./ltload bg-installer cli/.libs/main.o libbg-cli.la libbg-msg.la libbg-path.la libbg-iobuf.la libbg-fmt.la libbg-str.la libbg-sysdeps.la -static 
+ 
+ bg-installer.o: compile bg-installer.c sysdeps.h cli/cli.h fmt/number.h iobuf/ibuf.h iobuf/common.h iobuf/obuf.h iobuf/iobuf.h msg/msg.h msg/debug.h msg/wrap.h path/path.h str/str.h
+ 	./compile bg-installer.c
diff --git a/pkgs/development/libraries/bglibs/bglibs.patch b/pkgs/development/libraries/bglibs/bglibs.patch
new file mode 100644
index 0000000..a0b4111
--- /dev/null
+++ b/pkgs/development/libraries/bglibs/bglibs.patch
@@ -0,0 +1,14 @@
+diff -ru bglibs-1.106.orig/Makefile bglibs-1.106/Makefile
+--- bglibs-1.106.orig/Makefile	2009-02-19 18:11:51.000000000 +0100
++++ bglibs-1.106/Makefile	2013-09-12 15:11:46.887246484 +0200
+@@ -145,8 +145,8 @@
+ 	) >compile
+ 	chmod 755 compile
+ 
+-crc-gentab: crc-gentab.o ltload libbg-msg.la libbg-iobuf.la libbg-sysdeps.la
+-	./ltload crc-gentab libbg-msg.la libbg-iobuf.la libbg-sysdeps.la -static 
++crc-gentab: crc-gentab.o ltload libbg-msg.la libbg-iobuf.la libbg-fmt.la libbg-str.la libbg-sysdeps.la
++	./ltload crc-gentab libbg-msg.la libbg-iobuf.la libbg-fmt.la libbg-str.la libbg-sysdeps.la -static 
+ 
+ crc-gentab.o: compile crc-gentab.c sysdeps.h iobuf/iobuf.h iobuf/common.h iobuf/ibuf.h iobuf/obuf.h msg/msg.h msg/debug.h
+ 	./compile crc-gentab.c
diff --git a/pkgs/development/libraries/bglibs/bglibs2.patch b/pkgs/development/libraries/bglibs/bglibs2.patch
new file mode 100644
index 0000000..b0694f3
--- /dev/null
+++ b/pkgs/development/libraries/bglibs/bglibs2.patch
@@ -0,0 +1,108 @@
+diff -ru bglibs-2.03.orig/INSTHIER bglibs-2.03/INSTHIER
+--- bglibs-2.03.orig/INSTHIER	2015-02-07 00:57:34.000000000 +0100
++++ bglibs-2.03/INSTHIER	2016-07-25 20:09:00.379849512 +0200
+@@ -24,11 +24,10 @@
+ 
+ >lib
+ l:::755::libbg.la
+-c:::644::libbg-cli.a:.libs/libbg-cli.a
+-
+-c:::644::libpwcmp.a:.libs/libpwcmp.a
+-c:::644::libpwcmp-module.a:.libs/libpwcmp-module.a
+-c:::644::libvmailmgr.a:.libs/libvmailmgr.a
++l:::755::libvmailmgr.la
++l:::755::libbg-cli.la
++l:::755::libpwcmp.la
++l:::755::libpwcmp-module.la
+ 
+ >man
+ d:::755:man1
+diff -ru bglibs-2.03.orig/Makefile bglibs-2.03/Makefile
+--- bglibs-2.03.orig/Makefile	2015-02-06 23:57:34.000000000 +0000
++++ bglibs-2.03/Makefile	2016-07-25 17:57:19.606584705 +0000
+@@ -69,7 +69,7 @@
+ adt/hashs.lo adt/hashs.o: ltcompile adt/hashs.c include/bglibs/adt_common.h
+ 	./ltcompile adt/hashs.c
+ 
+-all: sysdeps.h libraries programs man selftests
++all: sysdeps.h libraries programs man
+ 
+ base64/asc2bin.lo base64/asc2bin.o: ltcompile base64/asc2bin.c include/bglibs/base64.h include/bglibs/str.h sysdeps.h
+ 	./ltcompile base64/asc2bin.c
+@@ -90,10 +90,12 @@
+ 	./ltcompile base64/encode_part.c
+ 
+ bg-installer: bg-installer.o ltload libbg-cli.la libbg.la bg-installer-cli.o
+-	./ltload bg-installer libbg-cli.la libbg.la bg-installer-cli.o -lbg-cli -static 
++	./ltload bg-installer bg-installer-cli.o fmt/.libs/*.o str/.libs/*.o iobuf/.libs/*.o path/.libs/*.o msg/.libs/w*.o msg/.libs/die*.o msg/.libs/common*.o msg/.libs/error*.o msg/.libs/oom.o sys/.libs/iopoll.o cli/.libs/main.o -s -static
+ 
+ bg-installer-cli.c: bg-installer.cli cli-generate sysdeps.h
+ 	./cli-generate -c $< >$@
++	echo 'const char cli_help_prefix[] = "";' >> $@
++	echo 'const char cli_help_suffix[] = "";' >> $@
+ 
+ bg-installer-cli.h: bg-installer.cli cli-generate
+ 	./cli-generate -h $< >$@
+@@ -157,7 +159,7 @@
+ 	chmod 755 compile
+ 
+ crc-gentab: crc-gentab.o load fmt/lcase.o fmt/ucase.o fmt/unum.o iobuf/iobuf_timeout.o iobuf/obuf_flush.o iobuf/obuf_pad.o iobuf/obuf_put3s.o iobuf/obuf_put5s.o iobuf/obuf_putc.o iobuf/obuf_putunumw.o iobuf/obuf_stderr.o iobuf/obuf_stdout.o iobuf/obuf_write.o msg/common.o msg/die.o sys/iopoll.o
+-	./load crc-gentab fmt/lcase.o fmt/ucase.o fmt/unum.o iobuf/iobuf_timeout.o iobuf/obuf_flush.o iobuf/obuf_pad.o iobuf/obuf_put3s.o iobuf/obuf_put5s.o iobuf/obuf_putc.o iobuf/obuf_putunumw.o iobuf/obuf_stderr.o iobuf/obuf_stdout.o iobuf/obuf_write.o msg/common.o msg/die.o sys/iopoll.o -static 
++	./load crc-gentab fmt/lcase.o fmt/ucase.o fmt/unum.o iobuf/iobuf_timeout.o iobuf/obuf_flush.o iobuf/obuf_pad.o iobuf/obuf_put3s.o iobuf/obuf_put5s.o iobuf/obuf_putc.o iobuf/obuf_putunumw.o iobuf/obuf_stderr.o iobuf/obuf_stdout.o iobuf/obuf_write.o msg/common.o msg/die.o sys/iopoll.o
+ 
+ crc-gentab.o: compile crc-gentab.c sysdeps.h include/bglibs/iobuf.h include/bglibs/iobuf_common.h include/bglibs/ibuf.h include/iobuf_common.h include/bglibs/obuf.h sysdeps.h include/bglibs/msg.h sysdeps.h include/bglibs/debug.h
+ 	./compile crc-gentab.c
+@@ -530,7 +532,8 @@
+ load: conf-ld
+ 	( echo '#!/bin/sh';\
+ 	  echo 'main="$$1"; shift';\
+-	  echo exec `head -n 1 conf-ld` -L. '-o "$$main" "$$main.o" $${1+"$$@"}'; \
++	  echo 'args=`echo "$$@" | sed -e "s|\.libs||g" -e "s|/|/.libs/|g" -e "s|^/||"`';\
++	  echo exec `head -n 1 conf-ld` -L. '-o "$$main" "$$main.o" $${1+$$args}'; \
+ 	) >load
+ 	chmod 755 load
+ 
+diff -ru bglibs-2.03.orig/net/dns_ip6.c bglibs-2.03/net/dns_ip6.c
+--- bglibs-2.03.orig/net/dns_ip6.c	2015-02-07 00:57:35.000000000 +0100
++++ bglibs-2.03/net/dns_ip6.c	2016-07-21 19:43:20.297968858 +0200
+@@ -82,5 +82,5 @@
+ result=0
+ 1.2.3.4 1: ::ffff:1.2.3.4
+ result=0
+-google.ca 1: 2607:f8b0:400a:*
++google.ca 1: 2a00:1450:400d:*::2003
+ #endif
+diff -ru bglibs-2.03.orig/net/dns_mx.c bglibs-2.03/net/dns_mx.c
+--- bglibs-2.03.orig/net/dns_mx.c	2015-02-07 00:57:35.000000000 +0100
++++ bglibs-2.03/net/dns_mx.c	2016-07-21 19:43:20.297968858 +0200
+@@ -76,7 +76,7 @@
+ #ifdef SELFTEST_EXP
+ result=0
+ untroubled.org => 1
+-0 12801: "mx.futurequest.net"
++0 1: "mx.futurequest.net"
+ result=0
+ google.com => 5
+ 0 10: "aspmx.l.google.com"
+diff -ru bglibs-2.03.orig/net/dns_txt.c bglibs-2.03/net/dns_txt.c
+--- bglibs-2.03.orig/net/dns_txt.c	2015-02-07 00:57:35.000000000 +0100
++++ bglibs-2.03/net/dns_txt.c	2016-07-21 19:43:20.297968858 +0200
+@@ -76,16 +76,9 @@
+ }
+ MAIN
+ {
+-  doit("gmail.com");
+-  doit("2.0.0.127.sbl-xbl.spamhaus.org");
++//  doit("gmail.com");
++//  doit("2.0.0.127.sbl-xbl.spamhaus.org");
+ }
+ #endif
+ #ifdef SELFTEST_EXP
+-result=0
+-1 record
+-v=spf1 redirect=_spf.google.com
+-result=0
+-2 record
+-http://www.spamhaus.org/sbl/query/SBL233
+-http://www.spamhaus.org/query/bl?ip=127.0.0.2
+ #endif
diff --git a/pkgs/development/libraries/bglibs/default.nix b/pkgs/development/libraries/bglibs/default.nix
new file mode 100644
index 0000000..748c808
--- /dev/null
+++ b/pkgs/development/libraries/bglibs/default.nix
@@ -0,0 +1,51 @@
+{ fetchurl, lib, libtool, perl, stdenv, which }:
+
+let
+  pkg = "bglibs";
+  homepage = http://untroubled.org/bglibs;
+
+  generic =  { version, sha256, patch }: stdenv.mkDerivation rec {
+    name = "${pkg}-${version}";
+
+    src = fetchurl {
+      url = "${homepage}/archive/${name}.tar.gz";
+      sha256 = sha256;
+    };
+
+    buildInputs = [libtool which perl];
+
+    patches = [ patch ];
+
+    configurePhase = ''
+      #echo "gcc -s -static" > conf-ld
+      echo $out/include > conf-include
+      echo $out/lib > conf-lib
+      echo $out/bin > conf-bin
+      echo $out/man > conf-man
+    '';
+
+    meta = {
+      description = "One stop library package";
+      homepage = homepage;
+      license = stdenv.lib.licenses.lgpl21Plus.fullName;
+      platforms = stdenv.lib.platforms.gnu;
+      maintainers = with stdenv.lib.maintainers; [ tzeman ];
+    };
+
+  };
+
+in {
+  bglibs1 = generic {
+    version = "1.106";
+    sha256 = "1w4dagl2h1gps2kbzdk9zn3ls1c81q0d6cnczkr8zrc85lffb2jw";
+    patch = ./bglibs.patch;
+  };
+
+  bglibs2 = generic {
+    version = "2.03";
+    sha256 = "0f97n7r1ac5yig3w2f8181rixiag7wwlyp0mkjy9m0gpxqnhpj7w";
+    patch = ./bglibs2.patch;
+  };
+}
+
+# vim: et ts=2 sw=2 
diff --git a/pkgs/development/libraries/bglibs/diet.nix b/pkgs/development/libraries/bglibs/diet.nix
new file mode 100644
index 0000000..dcb5bda
--- /dev/null
+++ b/pkgs/development/libraries/bglibs/diet.nix
@@ -0,0 +1,45 @@
+{ stdenv, fetchurl, dietlibc, libtool, which, perl }:
+
+let
+  pkg = "bglibs";
+  ver = "1.106";
+  homepage = http://untroubled.org/bglibs;
+in stdenv.mkDerivation rec {
+  name = "${pkg}-${ver}";
+
+  src = fetchurl {
+    url = "${homepage}/archive/${name}.tar.gz";
+    sha256 = "1w4dagl2h1gps2kbzdk9zn3ls1c81q0d6cnczkr8zrc85lffb2jw";
+  };
+
+  buildInputs = [dietlibc libtool which perl];
+
+  patches = [
+    # libtool diet gcc... can't find main.o inside .a library
+    ./bg-installer.patch
+  ];
+
+  configurePhase = ''
+    echo "diet gcc" > conf-cc
+    echo "diet gcc -s -static" > conf-ld
+    echo $out/include/bglibs > conf-include
+    echo $out/lib > conf-lib
+    echo $out/bin > conf-bin
+    echo $out/man > conf-man
+  '';
+
+  allowedReferences = ["out" perl];
+  dontStrip = true; # diet does not need stripping
+  dontPatchELF = true; # we produce static binaries
+
+  meta = {
+    description = "One stop library package";
+    homepage = homepage;
+    license = stdenv.lib.licenses.lgpl21Plus.fullName;
+    platforms = stdenv.lib.platforms.gnu;
+    maintainers = with stdenv.lib.maintainers; [ tzeman ];
+  };
+
+}
+
+# vim: et ts=2 sw=2 
diff --git a/pkgs/top-level/all-packages.nix b/pkgs/top-level/all-packages.nix
index 3201ee6..b773b8c 100644
--- a/pkgs/top-level/all-packages.nix
+++ b/pkgs/top-level/all-packages.nix
@@ -722,6 +722,14 @@ let
 
   bluez-tools = callPackage ../tools/bluetooth/bluez-tools { };
 
+  inherit (callPackages ../development/libraries/bglibs { })
+    bglibs1
+    bglibs2;
+
+  bglibs = bglibs1;
+
+  diet-bglibs = callPackage ../development/libraries/bglibs/diet.nix { };
+
   bmon = callPackage ../tools/misc/bmon { };
 
   bochs = callPackage ../applications/virtualization/bochs { };
