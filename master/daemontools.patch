From: Tomas Zeman <tzeman@volny.cz>
Subject: [PATCH] tg/daemontools

daemontools-0.76

diff --git a/pkgs/tools/misc/daemontools/compile.patch b/pkgs/tools/misc/daemontools/compile.patch
new file mode 100644
index 0000000..2568a8b
--- /dev/null
+++ b/pkgs/tools/misc/daemontools/compile.patch
@@ -0,0 +1,12 @@
+--- daemontools.orig/src/Makefile	2001-07-12 18:49:49.000000000 +0200
++++ daemontools/src/Makefile	2013-09-24 17:11:35.660975053 +0200
+@@ -165,8 +165,7 @@
+ 
+ hasshsgr.h: chkshsgr choose compile hasshsgr.h1 hasshsgr.h2 load \
+ tryshsgr.c warn-shsgr
+-	./chkshsgr || ( cat warn-shsgr; exit 1 )
+-	./choose clr tryshsgr hasshsgr.h1 hasshsgr.h2 > hasshsgr.h
++	cat hasshsgr.h1 > hasshsgr.h
+ 
+ haswaitp.h: choose compile haswaitp.h1 haswaitp.h2 load trywaitp.c
+ 	./choose cl trywaitp haswaitp.h1 haswaitp.h2 > haswaitp.h
diff --git a/pkgs/tools/misc/daemontools/default.nix b/pkgs/tools/misc/daemontools/default.nix
new file mode 100644
index 0000000..0c9351c
--- /dev/null
+++ b/pkgs/tools/misc/daemontools/default.nix
@@ -0,0 +1,62 @@
+{ stdenv, fetchurl, dietlibc }:
+
+let
+  pkg = "daemontools";
+  ver = "0.76";
+  web = http://cr.yp.to;
+in stdenv.mkDerivation rec {
+  name = "${pkg}-${ver}";
+
+  srcs = [
+    (fetchurl {
+      url = "${web}/${pkg}/${pkg}-${ver}.tar.gz";
+      sha256 = "07scvw88faxkscxi91031pjkpccql6wspk4yrlnsbrrb5c0kamd5";
+    })
+    (fetchurl {
+      url = "http://smarden.org/pape/djb/manpages/${pkg}-${ver}-man.tar.gz";
+      sha256 = "02k06k2f69jl758cz6hfmnvzxq5vyyik29b7hzshv2l7w2ppfk8v";
+    })
+  ];
+  sourceRoot = "admin/${pkg}-${ver}";
+
+  patches = [
+    # Avoid need to have secondary groups for compilation
+    # Install dnsroots.global into $out/etc
+    ./compile.patch
+    # Fix PATH for rts tests
+    ./rts.patch
+  ];
+
+  buildInputs = [dietlibc];
+
+  configurePhase = ''
+    echo "diet gcc" > src/conf-cc
+    echo "diet gcc -s -static" > src/conf-ld
+  '';
+
+  buildPhase = "./package/compile";
+
+  installPhase = ''
+    mkdir -p $out/bin
+    for BIN in `cat package/commands`; do
+      cp command/$BIN $out/bin
+    done
+    mkdir -p $out/man/man8
+    cp $NIX_BUILD_TOP/${pkg}-man/*.8 $out/man/man8/
+  '';
+
+  allowedReferences = ["out"];
+  dontPatchShebangs = true; # /bin/sh
+  dontStrip = true; # diet does not need stripping
+  dontPatchELF = true; # we produce static binaries
+
+  meta = {
+    description = "A collection of tools for managing UNIX services";
+    homepage = "${web}/{$pkg}.html";
+    license = stdenv.lib.licenses.publicDomain.shortName;
+    platforms = stdenv.lib.platforms.gnu;
+    maintainers = with stdenv.lib.maintainers; [ tzeman ];
+  };
+}
+
+# vim: et ts=2 sw=2 
diff --git a/pkgs/tools/misc/daemontools/rts.patch b/pkgs/tools/misc/daemontools/rts.patch
new file mode 100644
index 0000000..5bea86b
--- /dev/null
+++ b/pkgs/tools/misc/daemontools/rts.patch
@@ -0,0 +1,24 @@
+diff -ru daemontools-0.76.orig/src/Makefile daemontools-0.76/src/Makefile
+--- daemontools-0.76.orig/src/Makefile	2001-07-12 18:49:49.000000000 +0200
++++ daemontools-0.76/src/Makefile	2013-09-25 11:45:56.358024669 +0200
+@@ -265,7 +265,7 @@
+ rts: envdir envuidgid fghack matchtest multilog pgrphack \
+ readproctitle rts.tests setlock setuidgid softlimit supervise svc \
+ svok svscan svscanboot svstat tai64n tai64nlocal
+-	env - /bin/sh rts.tests 2>&1 | cat -v > rts
++	/bin/sh rts.tests 2>&1 | cat -v > rts
+ 
+ scan_ulong.o: compile scan.h scan_ulong.c
+ 	./compile scan_ulong.c
+diff -ru daemontools-0.76.orig/src/rts.tests daemontools-0.76/src/rts.tests
+--- daemontools-0.76.orig/src/rts.tests	2001-07-12 18:49:49.000000000 +0200
++++ daemontools-0.76/src/rts.tests	2013-09-25 11:35:21.617953581 +0200
+@@ -41,7 +41,7 @@
+ # softlimit -t
+ 
+ 
+-PATH=`pwd`:/command:/usr/local/bin:/usr/local/sbin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/X11R6/bin
++PATH=`pwd`:$PATH
+ export PATH
+ 
+ umask 022
diff --git a/pkgs/top-level/all-packages.nix b/pkgs/top-level/all-packages.nix
index dcaaa39..051c3d0 100644
--- a/pkgs/top-level/all-packages.nix
+++ b/pkgs/top-level/all-packages.nix
@@ -533,6 +533,8 @@ let
 
   dlx = callPackage ../misc/emulators/dlx { };
 
+  daemontools = callPackage ../tools/misc/daemontools { };
+
   eggdrop = callPackage ../tools/networking/eggdrop { };
 
   enca = callPackage ../tools/text/enca { };
